# Foreign Assets Schedule Calculator

## ‚ö†Ô∏è **DISCLAIMER**

**I am not a tax expert or certified financial advisor.** This tool is provided for educational and informational purposes only. I make **no claims about the correctness, accuracy, or completeness** of the calculations, formats, or tax compliance of the generated output.

**You are solely responsible for:**
- Verifying all calculations and data accuracy
- Ensuring compliance with current tax laws and regulations
- Consulting with qualified tax professionals before filing
- Any consequences arising from the use of this tool

**Use this tool at your own risk.** I assume **no liability** for any errors, omissions, or damages resulting from its use.

---
## üìù Overview  
This utility is designed to facilitate the calculation of the FA schedule in the Income Tax Return (ITR).  

- Specify the vest date and the number of shares received in the `vest.json` file. The script will automatically retrieve the vest price from the stock's closing price and store it in the cache for future reference. (Certain data related to UBER is already pre-cached.)  
- Record details of any sales transactions and the corresponding proceeds in the `sell.json` file.  
- Execute the script by specifying the relevant year as an argument. This will generate a `.csv` file corresponding to the selected year. The script can be reused in subsequent years by adding new vests and running it again with the updated year. For example, to prepare the return for **FY 2024‚Äì25**, use **2024** as the argument.  
- The generated `.csv` file can then be uploaded to the **A3 section** of the FA schedule.

**üß™ Comprehensive Testing**: This project includes a robust test suite with 15 test scenarios covering core calculations, command-line options, error handling, and edge cases. See the [Testing section](#-testing) for details.  

### üîé Notes  
- Ensure that the vest and sales data entered in the JSON files are accurate, as errors will directly impact the generated report.  
- Cached stock prices can be reused; however, if there are discrepancies, clear the cache and rerun the script to fetch updated prices.  
- The `.csv` output file is structured to match the format required in the FA schedule, reducing the need for manual adjustments.  
- Always verify the final upload to the ITR portal for correctness before submission.  
- The **closing price of the stock on the vest date** is taken as the FMV (Fair Market Value). This can be overridden in the `public_data.json` file.  
- Individual lots can also override the FMV by specifying the `vest_price_optional` field in the lot‚Äôs data.  
- The **Income Tax utility requires the first field to be ‚ÄúSerial No.‚Äù instead of ‚ÄúCountry‚Äù** as shown in its downloadable template. This is a known bug in their template. The final `.csv` generated by this script includes ‚ÄúSerial No.‚Äù as the first field, which works correctly when uploaded to the Income Tax portal.  


## üìÅ **File Overview**

This project contains several key files that work together to calculate your Foreign Assets Schedule:

### **üìÇ Data Directory Structure**
By default, all data files are expected in the same directory as the `fa_calculator.py` script. You can organize your data in separate directories using the `--data` option:

```
my_data/
‚îú‚îÄ‚îÄ vest.json              # Your vest transactions
‚îú‚îÄ‚îÄ sell.json              # Your sale transactions
‚îú‚îÄ‚îÄ public_data.json       # Cached market data (auto-generated)
‚îî‚îÄ‚îÄ FA.csv                 # Generated FA schedule (output)
```

### **üìä Input Files (Your Data)**
- **`vest.json`** - Your stock vest transactions
  - Contains vest dates, number of shares, and optional vest prices
  - Organized by stock symbol (e.g., AAPL, MSFT, UBER)
  - Located in your data directory (default: script directory)

- **`sell.json`** - Your stock sale transactions  
  - Contains sale dates, shares sold, and sale proceeds in INR
  - Links sales back to specific vest lots
  - Leave empty `{}` if you haven't sold any stocks
  - Located in your data directory

### **üîß Processing Scripts**
- **`fa_calculator.py`** - The main calculation engine
  - Fetches stock prices and exchange rates from internet
  - Performs all FA schedule calculations
  - Generates the final `FA.csv` output file

- **`clean_up_pii.py`** - Personal data cleanup utility
  - Removes your personal transaction data
  - Creates template files with sample data
  - Useful for sharing or backing up the tool

- **`clean_up_public_data.py`** - Cache management utility
  - Manages cached stock prices and exchange rates
  - Can delete specific stocks or all cached data
  - Helps when you need fresh data from internet

### **üíæ Generated Files**
- **`public_data.json`** - Cached market data
  - Stores stock prices, exchange rates, company info
  - Automatically created and updated by the calculator in your data directory
  - Speeds up subsequent runs by avoiding re-fetching
  - **Can be manually edited** to override specific data points (e.g., if you need to correct stock prices or adjust vest price calculations for minor discrepancies)

- **`FA.csv`** - Your final Foreign Assets Schedule
  - The output file you'll use for tax filing
  - Contains all calculated values in proper format
  - Generated fresh each time you run the calculator in your data directory

### **üìã Configuration Files**
- **`requirements.txt`** - Python dependencies
  - Lists required Python packages (just `requests`)
  - Used with `pip3 install -r requirements.txt`

- **`README.md`** - This documentation file
  - Complete usage guide and troubleshooting
  - Examples and best practices

---

## üöÄ **Quick Start Guide**

### **Basic Usage**
```bash
# Calculate FA schedule for 2024 (most common usage)
python3 fa_calculator.py 2024

# Show detailed progress information
python3 fa_calculator.py -v 2024

# Use cached data only (no internet required)
python3 fa_calculator.py --no-internet 2024
```

### **Performance Options**
```bash
# Skip vest price validation (faster execution)
python3 fa_calculator.py -x 2024

# Skip JSON file sorting (preserve original order)
python3 fa_calculator.py -y 2024

# Combine options for fastest execution
python3 fa_calculator.py -x -y --no-internet 2024
```

### **üß™ Testing**
```bash
# Run all tests (recommended)
cd tests && python3 run_all_tests.py

# Run specific test suites
cd tests/core-tests && python3 run_core_tests.py
cd tests/options-tests && python3 run_options_tests.py
```

### **File Management**
```bash
# Use custom data directory
python3 fa_calculator.py --data ./my_data 2024

# Clean up personal data (creates template files)
python3 clean_up_pii.py --data ./my_data

# Clean up cached market data
python3 clean_up_public_data.py -a
```

### **Help & Options**
```bash
# Show all available options
python3 fa_calculator.py --help

# Show cleanup options
python3 clean_up_public_data.py --help
```

---

## üìñ **Detailed Guide**

### **What This Tool Does**

A comprehensive **Python 3.7+** utility to calculate the Foreign Assets Schedule for Income Tax Return forms. This tool:

- Fetches real-time stock prices from Yahoo Finance
- Retrieves USD-INR exchange rates from SBI data
- Calculates peak values during the tax year
- Generates properly formatted CSV output for tax filing
- Handles complex scenarios like partial sales and vest prices

### **Command Line Options**

| Option | Description | Example |
|--------|-------------|---------|
| `year` | Tax year for calculation (required) | `2024` |
| `-v, --verbose` | Show detailed progress information | `-v` |
| `-x, --exclude-validation` | Skip vest price validation | `-x` |
| `-y, --no-sort` | Skip JSON file sorting | `-y` |
| `--no-internet` | Use cached data only | `--no-internet` |
| `--data` | Custom data directory (default: script directory) | `--data ./my_data` |

### **Processing Steps**

The calculator follows these steps:

1. **üîç Step 1**: Validating input data
   - Loads and validates `vest.json` and `sell.json` from data directory
   - Checks sales against vest lots
   - Validates year parameter

2. **üåê Step 2**: Fetching required data from internet
   - Downloads missing stock prices from Yahoo Finance
   - Fetches USD-INR exchange rates from SBI data
   - Retrieves company information
   - Gets high/low prices for vest validation (if enabled)
   - Updates `public_data.json` cache in data directory

3. **üìã Step 3**: Sorting data files (unless `-y` used)
   - Sorts stocks alphabetically
   - Sorts dates chronologically
   - Updates all JSON files in data directory

4. **üßÆ Step 4**: Calculating Foreign Assets Schedule
   - Processes each stock lot individually
   - Calculates peak prices during tax year
   - Computes values in INR using SBI rates
   - Generates `FA.csv` output in data directory

### **Input File Formats**

#### **`vest.json`** - Purchase Transactions
```json
{
  "AAPL": {
    "vests": [
      {
        "vest_date": "2023-03-15",
        "number_of_shares": 100,
        "vest_price_optional": 150.25
      }
    ]
  }
}
```

#### **`sell.json`** - Sale Transactions
```json
{
  "AAPL": {
    "sales": [
      {
        "sell_date": "2024-06-20",
        "purchase_date": "2023-03-15",
        "number_of_shares": 50,
        "sell_price_inr": 650000.00
      }
    ]
  }
}
```

### **Output Format**

The tool generates `FA.csv` with the following columns (matching ITR FA Schedule format):

1. **Serial Number** - Auto-generated sequence number
2. **Country Name and Code** - Numeric country code (2 for United States)
3. **Name of Entity** - Company name (e.g., "Apple Inc.")
4. **Address of Entity** - Company address
5. **ZIP Code** - Company ZIP/postal code
6. **Nature of Entity** - Type of entity (e.g., "Public Limited Company")
7. **Date of Acquiring Interest** - Vest date (YYYY-MM-DD)
8. **Initial Value of Investment** - Purchase value in INR
9. **Peak Value During Period** - Highest value during tax year in INR
10. **Closing Balance** - Year-end value in INR
11. **Total Gross Amount Paid** - Dividends/other payments in INR (usually 0)
12. **Total Gross Proceeds** - Sale proceeds in INR (if sold during year)

**Note**: The first column is "Serial Number" (not "Country/Region name" as shown in some ITR templates). This format works correctly when uploaded to the Income Tax portal.

### **Advanced Features**

#### **Vest Price Validation**
- Validates optional vest prices against daily high/low ranges
- Prevents invalid price entries
- Can be disabled with `-x` flag for faster execution

#### **Intelligent Caching**
- Stores all fetched data in `public_data.json`
- Reuses cached data across runs
- Automatically updates missing information

#### **Flexible Data Sources**
- Primary: Yahoo Finance for stock prices
- Fallback: Enhanced local company database
- Exchange rates: SBI historical data

#### **Error Handling**
- Comprehensive input validation
- Graceful handling of network issues
- Clear error messages with suggested fixes

## üêç **Python Scripts**

### 1. **`fa_calculator.py`** - Main FA Calculator
The primary calculation engine with full feature set.

### 2. **`clean_up_pii.py`** - PII Data Cleanup
```bash
# Clean all personal transaction data
python3 clean_up_pii.py
```
Creates template files with sample data, removing all personal information.

### 3. **`clean_up_public_data.py`** - Public Data Cache Cleanup
```bash
# Delete all cached data
python3 clean_up_public_data.py -a

# Delete all stock data (keep exchange rates)
python3 clean_up_public_data.py -s

# Delete only exchange rates
python3 clean_up_public_data.py -x

# Delete specific stock data
python3 clean_up_public_data.py AAPL
```

## üì¶ **Installation**

### Prerequisites
- **Python 3.7+** (check with `python3 --version`)
- **pip3** for package installation

### Install Dependencies
```bash
# Install required packages
pip3 install -r requirements.txt

# Or install manually (only one external dependency)
pip3 install requests
```

### Verify Installation
```bash
# Test syntax compilation
python3 -m py_compile fa_calculator.py
python3 -m py_compile clean_up_pii.py
python3 -m py_compile clean_up_public_data.py

# Test help messages
python3 fa_calculator.py --help
python3 clean_up_public_data.py --help
```

## üöÄ **Key Features**

### **Technical Advantages:**
‚úÖ **Cross-Platform**: Works on Windows, macOS, Linux  
‚úÖ **Robust Error Handling**: Detailed exception messages  
‚úÖ **Type Safety**: Type hints for better code quality  
‚úÖ **JSON Native**: Built-in JSON support for data handling  
‚úÖ **HTTP Library**: Reliable `requests` library for API calls  
‚úÖ **Date Handling**: Powerful `datetime` module for date calculations  
‚úÖ **Code Readability**: Maintainable and extensible codebase  
‚úÖ **IDE Support**: Full debugging and autocomplete support  

### **Performance:**
- **Fast JSON Processing**: Native JSON handling for large datasets
- **Efficient HTTP**: Connection pooling and proper timeout handling
- **Memory Management**: Optimized handling of large datasets
- **Extensible**: Easy to add parallel processing if needed

### **Reliability:**
- **Exception Handling**: Graceful error recovery and user feedback
- **Input Validation**: Comprehensive argument and data validation
- **Data Integrity**: Atomic file operations and backup handling
- **Debugging Support**: Easy to add detailed logging and diagnostics

## üìÅ **File Structure**

This project contains all necessary files:

```
‚îú‚îÄ‚îÄ fa_calculator.py          # Main calculator (Python)
‚îú‚îÄ‚îÄ clean_up_pii.py          # PII cleanup (Python)
‚îú‚îÄ‚îÄ clean_up_public_data.py  # Cache cleanup (Python)
‚îú‚îÄ‚îÄ requirements.txt         # Python dependencies
‚îú‚îÄ‚îÄ README.md               # This file
‚îú‚îÄ‚îÄ vest.json              # Vest transactions
‚îú‚îÄ‚îÄ sell.json               # Sale transactions  
‚îú‚îÄ‚îÄ public_data.json        # Cached market data
‚îî‚îÄ‚îÄ FA.csv                  # Generated FA schedule
```

## üîß **Configuration**

### **Environment Variables** (Optional)
```bash
# Set custom timeout for HTTP requests
export FA_CALC_TIMEOUT=60

# Set custom cache update interval
export FA_CALC_CACHE_INTERVAL=10

# Set custom fetch delay (rate limiting)
export FA_CALC_FETCH_DELAY=2
```

### **Customization**
The Python scripts are designed to be easily customizable:

```python
# In fa_calculator.py, you can modify:
class FACalculator:
    def __init__(self, ...):
        self.fetch_delay_seconds = 2      # Rate limiting
        self.cache_update_interval = 10   # Batch cache updates
        # ... other settings
```

## üß™ **Testing**

This project includes a comprehensive test suite to validate the FA calculator's core functionality and ensure accuracy across various scenarios.

### **üéØ Core Test Suite**
The core tests validate calculation correctness using pre-cached data (no internet required):

```bash
# Run all core tests
cd tests/core-tests
python3 run_core_tests.py
```

**Test Coverage:**
- ‚úÖ **15 comprehensive test scenarios**
- ‚úÖ **Core Tests (5)**: Calculation accuracy and correctness
  - Basic vests with no sales
  - Vest price overrides (`vest_price_optional`)
  - Partial stock sales during tax year
  - Multiple vests and multiple stocks
  - Advanced scenario: Peak value after partial sale
- ‚úÖ **Options Tests (10)**: CLI behavior and error handling
  - Command-line argument parsing
  - Verbose output and performance options
  - Data directory handling
  - Error handling for invalid inputs
  - Option combinations and interactions

### **üìä Test Results Example**
```bash
# Run all tests
cd tests && python3 run_all_tests.py
```
```
üöÄ FA Calculator - Comprehensive Test Suite
============================================================
üß™ Running Core Functionality Tests...
Found 5 test directories:
  Running data1 (year 2023)... PASSED
  Running data2 (year 2023)... PASSED
  Running data3 (year 2023)... PASSED
  Running data4 (year 2023)... PASSED
  Running data5 (year 2023)... PASSED

üß™ Running Command-Line Options Tests...
  Running help_option... PASSED
  Running verbose_option... PASSED
  Running skip_validation_option... PASSED
  Running data_option... PASSED
  Running combined_options... PASSED
  [... 5 more tests ...]

üéâ ALL TEST SUITES PASSED!
```

### **üîß Manual Testing**
```bash
# Test with --no-internet (cache-only)
python3 fa_calculator.py --no-internet 2023

# Test specific data directory
python3 fa_calculator.py --data tests/core-tests/data1 2023 --no-internet -x -y

# Test cleanup scripts (be careful!)
echo "n" | python3 clean_up_public_data.py AAPL
```

**Note**: All tests use `--no-internet` to ensure fast, reproducible results. The `--no-internet` option itself is not tested since it's used by all tests.

### **üìÇ Test Organization**
```
tests/
‚îú‚îÄ‚îÄ run_all_tests.py      # Master test runner (runs all suites)
‚îú‚îÄ‚îÄ core-tests/           # Core functionality tests (5 scenarios)
‚îÇ   ‚îú‚îÄ‚îÄ run_core_tests.py # Core test runner
‚îÇ   ‚îú‚îÄ‚îÄ data1/            # Simple vest scenario
‚îÇ   ‚îú‚îÄ‚îÄ data2/            # Vest price override
‚îÇ   ‚îú‚îÄ‚îÄ data3/            # Partial sales
‚îÇ   ‚îú‚îÄ‚îÄ data4/            # Multiple vests
‚îÇ   ‚îî‚îÄ‚îÄ data5/            # Peak after sale
‚îî‚îÄ‚îÄ options-tests/        # CLI options tests (10 scenarios)
    ‚îú‚îÄ‚îÄ run_options_tests.py  # Options test runner
    ‚îú‚îÄ‚îÄ README.md         # Options test documentation
    ‚îî‚îÄ‚îÄ test_data/        # Auto-generated test data
```

### **‚ö° Development Testing**
```bash
# Syntax check
python3 -m py_compile *.py

# Type checking (optional)
pip3 install mypy
mypy fa_calculator.py clean_up_pii.py
```

## üêõ **Troubleshooting**

### **Common Issues**

1. **`ModuleNotFoundError: No module named 'requests'`**
   ```bash
   pip3 install requests
   ```

2. **Permission denied**
   ```bash
   chmod +x *.py
   ```

3. **Python version too old**
   ```bash
   python3 --version  # Should be 3.7+
   ```

4. **JSON decode errors**
   - Check `vest.json` and `sell.json` syntax in your data directory
   - Use online JSON validator

5. **Network timeouts**
   - Check internet connection
   - Use `--no-internet` for cache-only mode

6. **Vest price validation errors**
   - Verify vest prices are within daily trading range
   - Use `-x` flag to skip validation if needed

### **Debug Mode**
Add debug prints by modifying the scripts:
```python
# Add at the top of any script
import logging
logging.basicConfig(level=logging.DEBUG)
```

## üìä **Data Formats**

The tool uses standard, human-readable formats:

### **File Compatibility**
- ‚úÖ **JSON Input**: Standard JSON format for `vest.json` and `sell.json` in data directory
- ‚úÖ **JSON Cache**: Organized cache format in `public_data.json` in data directory
- ‚úÖ **CSV Output**: Standard CSV format for `FA.csv` in data directory (compatible with Excel/Sheets)
- ‚úÖ **Cross-Platform**: All files work across Windows, macOS, and Linux
- ‚úÖ **Flexible Organization**: Use `--data` to organize files in separate directories


## üìû **Support**

For issues specific to the Python version:
1. Check Python version compatibility (3.7+)
2. Verify all dependencies are installed
3. Test with `--no-internet` mode first
4. Check file permissions and paths
5. Validate JSON file syntax

**Remember**: This tool is provided as-is without warranty. Always consult with qualified tax professionals for official tax advice and verification of calculations.
